{"version":3,"file":"google-custom-event-tracker.umd.js","sources":["../src/selector/selector.ts","../src/selector/xpath.ts","../src/index.ts"],"sourcesContent":["// Проверка уникальности селектора\nfunction isSelectorUnique(selector: string, target: Element): boolean {\n  try {\n    const matches = document.querySelectorAll(selector);\n    return matches.length === 1 && matches[0] === target;\n  } catch {\n    return false;\n  }\n}\n\nexport function buildSelector(node: Node): string | null {\n  if (!(node instanceof Element)) return null;\n\n  if (node.id) {\n    return `#${CSS.escape(node.id)}`;\n  }\n\n  const parts: string[] = [];\n  const tag = node.tagName.toLowerCase();\n\n  if (node.classList.length) {\n    const cls = node.classList[0];\n    parts.push(`.${CSS.escape(cls)}`);\n  }\n\n  Array.from(node.attributes).forEach((attr) => {\n    if (attr.name.startsWith(\"data-\")) {\n      parts.push(`[${attr.name}]`);\n    }\n  });\n\n  const shortSelector = parts[0];\n  if (shortSelector && isSelectorUnique(shortSelector, node)) {\n    return shortSelector;\n  }\n\n  // ✅ Собираем путь как массив\n  const pathParts: string[] = [];\n  let current: Element | null = node;\n\n  while (current && current.nodeType === Node.ELEMENT_NODE) {\n    const parent: Element | null = current.parentElement;\n    const tagName = current.tagName.toLowerCase();\n\n    let nth = \"\";\n    if (parent) {\n      const siblings = Array.from(parent.children).filter(\n        (el) => el.tagName.toLowerCase() === tagName,\n      );\n      if (siblings.length > 1) {\n        nth = `:nth-of-type(${siblings.indexOf(current) + 1})`;\n      }\n    }\n\n    pathParts.unshift(`${tagName}${nth}`);\n    current = parent;\n  }\n\n  return pathParts.join(\" > \") || null;\n}\n","export function buildXPath(node: Node): string {\n  switch (node.nodeType) {\n    case Node.DOCUMENT_NODE:\n      return \"/\";\n\n    case Node.DOCUMENT_TYPE_NODE:\n      return \"/html/doctype\";\n\n    case Node.ELEMENT_NODE: {\n      const element = node as Element;\n\n      if (element.id) {\n        return `//*[@id=\"${CSS.escape(element.id)}\"]`;\n      }\n\n      if (element.tagName.toLowerCase() === \"html\") return \"/html\";\n      if (element === document.head) return \"/html/head\";\n      if (element === document.body) return \"/html/body\";\n\n      const parent = element.parentNode;\n      if (!parent) return \"\";\n\n      const tag = element.tagName.toLowerCase();\n      const siblings = Array.from(parent.children).filter((el) => el.tagName.toLowerCase() === tag);\n      const index = siblings.length > 1 ? `[${siblings.indexOf(element) + 1}]` : \"\";\n\n      return `${buildXPath(parent)}/${tag}${index}`;\n    }\n\n    case Node.TEXT_NODE:\n    case Node.CDATA_SECTION_NODE:\n    case Node.COMMENT_NODE: {\n      const parent = node.parentNode;\n      if (!parent) return \"\";\n\n      const typeMap = {\n        [Node.TEXT_NODE]: \"text()\",\n        [Node.CDATA_SECTION_NODE]: \"text()\", // CDATA ≡ text() в XPath\n        [Node.COMMENT_NODE]: \"comment()\",\n      };\n\n      const sameTypeSiblings = Array.from(parent.childNodes).filter(\n        (sibling) => sibling.nodeType === node.nodeType,\n      );\n      const index =\n        sameTypeSiblings.length > 1 ? `[${sameTypeSiblings.indexOf(node as ChildNode) + 1}]` : \"\";\n\n      return `${buildXPath(parent)}/${typeMap[node.nodeType]}${index}`;\n    }\n\n    default:\n      return \"\";\n  }\n}\n","export { buildSelector } from \"./selector/selector\";\nexport { buildXPath } from \"./selector/xpath\";\n\n/**\n * Options used to configure event capture for the tracker.\n * @public\n * @remarks\n * All options are enabled by default for comprehensive tracking.\n */\nexport interface TrackerOptions {\n  send?: (data: Record<string, any>) => void;\n  captureText?: boolean;\n  captureSelector?: boolean;\n  capturePath?: boolean;\n  captureXPath?: boolean;\n  events?: {\n    mouseUp?: boolean;\n    mouseDown?: boolean;\n    click?: boolean;\n    contextMenu?: boolean;\n    dblClick?: boolean;\n    focus?: boolean;\n    blur?: boolean;\n    touchStart?: boolean;\n    touchEnd?: boolean;\n    touchCancel?: boolean;\n    input?: boolean;\n    play?: boolean;\n    pause?: boolean;\n    seeked?: boolean;\n    volumeChange?: boolean;\n    rateChange?: boolean;\n  };\n}\n\nimport { buildSelector } from \"./selector/selector\";\nimport { buildXPath } from \"./selector/xpath\";\n\nlet handler: ((e: Event) => void) | null = null;\nlet waitForGtagTimer: ReturnType<typeof setInterval> | null = null;\nconst POLL_INTERVAL = 50;\nconst MAX_WAIT = 5000;\n\nconst isVitest = typeof import.meta !== \"undefined\" && !!(import.meta as any).vitest;\n\nconst DEFAULT_EVENTS = {\n  mouseUp: false,\n  mouseDown: false,\n  click: true,\n  contextMenu: true,\n  dblClick: true,\n  focus: true,\n  blur: true,\n  touchStart: true,\n  touchEnd: true,\n  touchCancel: true,\n  input: true,\n  play: true,\n  pause: true,\n  seeked: true,\n  volumeChange: true,\n  rateChange: true,\n};\n\n/**\n * Initializes the tracker and attaches DOM listeners for various events.\n * @public\n * @param options Capture configuration and a send callback invoked for each event.\n * @returns void\n * @remarks\n * Must be called in a browser-like environment; re-invocation resets existing listeners.\n */\nexport function initTracker(options: TrackerOptions = {}) {\n  const opts = {\n    send: (payload: Record<string, any>) => {\n      console.log(\"Event tracked:\", payload);\n    },\n    captureText: true,\n    captureSelector: true,\n    capturePath: true,\n    captureXPath: true,\n    events: { ...DEFAULT_EVENTS, ...options.events },\n    ...options,\n  };\n  console.log(`initTracker: ${JSON.stringify(opts)}`);\n\n  // Remove existing listeners if any\n  if (handler) {\n    Object.keys(DEFAULT_EVENTS).forEach((eventName) => {\n      const mappedEventName =\n        eventName === \"dblClick\"\n          ? \"dblclick\"\n          : eventName === \"volumeChange\"\n            ? \"volumechange\"\n            : eventName === \"rateChange\"\n              ? \"ratechange\"\n              : eventName.toLowerCase();\n\n      document.removeEventListener(mappedEventName, handler as EventListener);\n    });\n  }\n\n  handler = (e: Event) => {\n    const el = e.target as Element | null;\n    if (!el) return;\n\n    // Check if this event type should be tracked\n    const eventKey =\n      e.type === \"dblclick\"\n        ? \"dblClick\"\n        : e.type === \"volumechange\"\n          ? \"volumeChange\"\n          : e.type === \"ratechange\"\n            ? \"rateChange\"\n            : Object.keys(DEFAULT_EVENTS).find((key) => key.toLowerCase() === e.type);\n\n    if (!eventKey || !opts.events[eventKey as keyof typeof DEFAULT_EVENTS]) return;\n\n    const payload: any = {\n      type: e.type,\n      tag: el.tagName.toLowerCase(),\n      ts: Date.now(),\n    };\n\n    if (opts.captureText) {\n      payload.text =\n        el instanceof HTMLInputElement\n          ? el.value\n          : el instanceof HTMLTextAreaElement\n            ? el.value\n            : el.textContent?.trim() || null;\n    }\n\n    let selector: string | null = null;\n    if (opts.captureSelector) {\n      selector = buildSelector(el);\n      payload.selector = selector;\n    }\n\n    if (opts.capturePath) {\n      payload.path = selector ?? buildSelector(el);\n    }\n\n    if (opts.captureXPath) {\n      payload.xpath = buildXPath(el);\n    }\n\n    opts.send(payload);\n  };\n\n  // Add listeners for all enabled events\n  Object.entries(opts.events).forEach(([eventName, isEnabled]) => {\n    if (!isEnabled) return;\n\n    const mappedEventName =\n      eventName === \"dblClick\"\n        ? \"dblclick\"\n        : eventName === \"volumeChange\"\n          ? \"volumechange\"\n          : eventName === \"rateChange\"\n            ? \"ratechange\"\n            : eventName.toLowerCase();\n\n    document.addEventListener(mappedEventName, handler as EventListener);\n  });\n}\n\n/**\n * Starts a polling loop that waits for `gtag` or `dataLayer` and auto-initializes the tracker.\n * @public\n * @returns void\n * @remarks\n * Designed for browser environments where GA4 or GTM may load asynchronously.\n */\nexport function startAutoInit() {\n  if (typeof window === \"undefined\") return;\n\n  if (waitForGtagTimer) {\n    clearInterval(waitForGtagTimer);\n  }\n\n  let waited = 0;\n\n  waitForGtagTimer = setInterval(() => {\n    if (typeof window === \"undefined\") {\n      clearInterval(waitForGtagTimer!);\n      waitForGtagTimer = null;\n      return;\n    }\n\n    waited += POLL_INTERVAL;\n\n    const gtag = (window as any).gtag;\n    const dataLayer = (window as any).dataLayer;\n\n    const hasDataLayer = Array.isArray(dataLayer) && typeof dataLayer.push === \"function\";\n\n    if (typeof gtag === \"function\" || hasDataLayer) {\n      clearInterval(waitForGtagTimer!);\n      waitForGtagTimer = null;\n\n      initTracker({\n        // send events through gtag when it is available\n        send: (payload) => {\n          if (typeof gtag === \"function\") {\n            gtag(\"event\", \"ui_event\", payload);\n          } else {\n            dataLayer.push({\n              event: \"ui_event\",\n              ...payload,\n            });\n          }\n        },\n      });\n\n      return;\n    }\n\n    if (waited >= MAX_WAIT) {\n      clearInterval(waitForGtagTimer!);\n      waitForGtagTimer = null;\n      console.warn(\"[GCE] gtag did not initialize in time — tracking disabled\");\n    }\n  }, POLL_INTERVAL);\n}\n\n/**\n * Resets listeners and timers; intended for test environments.\n * @internal\n * @returns void\n * @remarks\n * —\n */\nexport function _resetTrackerForTests() {\n  if (handler) {\n    Object.keys(DEFAULT_EVENTS).forEach((eventName) => {\n      const mappedEventName =\n        eventName === \"dblClick\"\n          ? \"dblclick\"\n          : eventName === \"volumeChange\"\n            ? \"volumechange\"\n            : eventName === \"rateChange\"\n              ? \"ratechange\"\n              : eventName.toLowerCase();\n\n      document.removeEventListener(mappedEventName, handler as EventListener);\n    });\n    handler = null;\n  }\n\n  if (waitForGtagTimer) {\n    clearInterval(waitForGtagTimer);\n    waitForGtagTimer = null;\n  }\n}\n\nif (typeof window !== \"undefined\" && !isVitest) {\n  startAutoInit();\n}\n\nexport default { init: initTracker };\n"],"names":["isSelectorUnique","selector","target","matches","buildSelector","node","parts","cls","attr","shortSelector","pathParts","current","parent","tagName","nth","siblings","el","buildXPath","element","tag","index","typeMap","sameTypeSiblings","sibling","handler","waitForGtagTimer","POLL_INTERVAL","MAX_WAIT","isVitest","_documentCurrentScript","DEFAULT_EVENTS","initTracker","options","opts","payload","eventName","mappedEventName","eventKey","key","_a","isEnabled","startAutoInit","waited","gtag","dataLayer","hasDataLayer","_resetTrackerForTests"],"mappings":"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"}