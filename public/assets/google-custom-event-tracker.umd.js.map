{"version":3,"file":"google-custom-event-tracker.umd.js","sources":["../src/selector/unique.ts","../src/selector/selector.ts","../src/selector/xpath.ts","../src/index.ts"],"sourcesContent":["export function isSelectorUnique(selector: string, target: Element): boolean {\n  try {\n    const matches = document.querySelectorAll(selector);\n    return matches.length === 1 && matches[0] === target;\n  } catch {\n    return false;\n  }\n}\n","import { isSelectorUnique } from \"./unique\";\n\n/**\n * Builds a CSS selector following the rrweb fork heuristics, preferring short selectors and\n * falling back to a full path when needed.\n * @public\n * @param node Node to build a selector for.\n * @returns A unique selector for the element, or null when the node is not an element.\n * @remarks\n * Assumes a browser-like DOM environment.\n */\nexport function buildSelector(node: Node): string | null {\n  if (!(node instanceof Element)) return null;\n  const element: Element = node;\n\n  // 1. Prefer element ID because it yields the shortest unique selector.\n  if (element.id) {\n    return `#${CSS.escape(element.id)}`;\n  }\n\n  // 2. Attempt to build a short selector using tag, classes, and data-* attributes.\n  const tag = element.tagName.toLowerCase();\n  const parts: string[] = [];\n\n  if (element.classList.length > 0) {\n    for (const cls of Array.from(element.classList)) {\n      parts.push(`.${CSS.escape(cls)}`);\n    }\n  }\n\n  for (const attr of Array.from(element.attributes)) {\n    if (attr.name.startsWith(\"data-\")) {\n      parts.push(`[${attr.name}=\"${CSS.escape(attr.value)}\"]`);\n    }\n  }\n\n  const shortSelector = `${tag}${parts.join(\"\")}`;\n\n  if (shortSelector && isSelectorUnique(shortSelector, element)) {\n    return shortSelector;\n  }\n\n  // 3. Build a full path selector when the short form is not unique.\n  const pathParts: string[] = [];\n  let current: Element | null = element;\n\n  while (current && current.nodeType === Node.ELEMENT_NODE) {\n    const parent: Element | null = current.parentElement;\n    const tagName = current.tagName.toLowerCase();\n\n    let nth = \"\";\n\n    if (parent) {\n      const siblings = Array.from(parent.children).filter(\n        (el): el is Element => el instanceof Element && el.tagName.toLowerCase() === tagName,\n      );\n\n      if (siblings.length > 1) {\n        const index = siblings.indexOf(current);\n        if (index !== -1) {\n          nth = `:nth-of-type(${index + 1})`;\n        }\n      }\n    }\n\n    pathParts.unshift(`${tagName}${nth}`);\n    current = parent;\n  }\n\n  return pathParts.join(\" > \");\n}\n","/**\n * Builds an XPath string following the rrweb fork rules, covering element and text/comment nodes.\n * @public\n * @param node Node to produce an XPath for.\n * @returns An XPath targeting the provided node, or an empty string for unsupported nodes.\n * @remarks\n * Assumes a browser-like DOM environment and uses indexes when siblings share the same tag.\n */\nexport function buildXPath(node: Node): string {\n  switch (node.nodeType) {\n    case Node.DOCUMENT_NODE:\n      return \"/\";\n\n    case Node.DOCUMENT_TYPE_NODE:\n      return \"/html/doctype\";\n\n    case Node.ELEMENT_NODE: {\n      const element = node as Element;\n\n      // Prefer ID because it yields the shortest XPath.\n      if (element.id) {\n        return `//*[@id=\"${CSS.escape(element.id)}\"]`;\n      }\n\n      const tagName = element.tagName.toLowerCase();\n\n      if (tagName === \"html\") return \"/html\";\n      if (element === document.head) return \"/html/head\";\n      if (element === document.body) return \"/html/body\";\n\n      const parent = element.parentNode;\n      if (!parent) return \"\";\n\n      const siblings = Array.from((parent as Element).children).filter(\n        (el): el is Element => el instanceof Element && el.tagName.toLowerCase() === tagName,\n      );\n\n      const index = siblings.length > 1 ? `[${siblings.indexOf(element) + 1}]` : \"\";\n\n      return `${buildXPath(parent)}/${tagName}${index}`;\n    }\n\n    case Node.TEXT_NODE:\n    case Node.CDATA_SECTION_NODE:\n    case Node.COMMENT_NODE: {\n      const parent = node.parentNode;\n      if (!parent) return \"\";\n\n      const typeMap: Record<number, string> = {\n        [Node.TEXT_NODE]: \"text()\",\n        [Node.CDATA_SECTION_NODE]: \"text()\", // CDATA ≡ text() in XPath\n        [Node.COMMENT_NODE]: \"comment()\",\n      };\n\n      const sameTypeSiblings = Array.from(parent.childNodes).filter(\n        (sibling) => sibling.nodeType === node.nodeType,\n      );\n\n      const index =\n        sameTypeSiblings.length > 1 ? `[${sameTypeSiblings.indexOf(node as ChildNode) + 1}]` : \"\";\n\n      return `${buildXPath(parent)}/${typeMap[node.nodeType]}${index}`;\n    }\n\n    default:\n      return \"\";\n  }\n}\n","export { buildSelector } from \"./selector/selector\";\nexport { buildXPath } from \"./selector/xpath\";\n\n/**\n * Options used to configure event capture for the tracker.\n * @public\n * @remarks\n * —\n */\nexport interface TrackerOptions {\n  send: (data: Record<string, any>) => void;\n  captureText?: boolean;\n  captureSelector?: boolean;\n  capturePath?: boolean;\n  captureXPath?: boolean;\n}\n\nimport { buildSelector } from \"./selector/selector\";\nimport { buildXPath } from \"./selector/xpath\";\n\nlet handler: ((e: Event) => void) | null = null;\nlet waitForGtagTimer: ReturnType<typeof setInterval> | null = null;\nconst POLL_INTERVAL = 50;\nconst MAX_WAIT = 5000;\n\nconst isVitest = typeof import.meta !== \"undefined\" && !!(import.meta as any).vitest;\n\n/**\n * Initializes the tracker and attaches DOM listeners for click and input events.\n * @public\n * @param options Capture configuration and a send callback invoked for each event.\n * @returns void\n * @remarks\n * Must be called in a browser-like environment; re-invocation resets existing listeners.\n */\nexport function initTracker(options: TrackerOptions) {\n  const opts = {\n    captureText: true,\n    captureSelector: true,\n    capturePath: true,\n    captureXPath: true,\n    ...options,\n  };\n\n  if (handler) {\n    document.removeEventListener(\"click\", handler);\n    document.removeEventListener(\"input\", handler);\n  }\n\n  handler = (e: Event) => {\n    const el = e.target as Element | null;\n    if (!el) return;\n\n    const payload: any = {\n      type: e.type,\n      tag: el.tagName.toLowerCase(),\n      ts: Date.now(),\n    };\n\n    if (opts.captureText) {\n      payload.text = el instanceof HTMLInputElement ? el.value : el.textContent?.trim() || null;\n    }\n\n    let selector: string | null = null;\n    if (opts.captureSelector) {\n      selector = buildSelector(el);\n      payload.selector = selector;\n    }\n\n    if (opts.capturePath) {\n      payload.path = selector ?? buildSelector(el); // could be replaced with buildDomPath\n    }\n\n    if (opts.captureXPath) {\n      payload.xpath = buildXPath(el);\n    }\n\n    opts.send(payload);\n  };\n\n  document.addEventListener(\"click\", handler);\n  document.addEventListener(\"input\", handler);\n}\n\n/**\n * Starts a polling loop that waits for `gtag` or `dataLayer` and auto-initializes the tracker.\n * @public\n * @returns void\n * @remarks\n * Designed for browser environments where GA4 or GTM may load asynchronously.\n */\nexport function startAutoInit() {\n  if (typeof window === \"undefined\") return;\n\n  if (waitForGtagTimer) {\n    clearInterval(waitForGtagTimer);\n  }\n\n  let waited = 0;\n\n  waitForGtagTimer = setInterval(() => {\n    if (typeof window === \"undefined\") {\n      clearInterval(waitForGtagTimer!);\n      waitForGtagTimer = null;\n      return;\n    }\n\n    waited += POLL_INTERVAL;\n\n    const gtag = (window as any).gtag;\n    const dataLayer = (window as any).dataLayer;\n\n    const hasDataLayer = Array.isArray(dataLayer) && typeof dataLayer.push === \"function\";\n\n    if (typeof gtag === \"function\" || hasDataLayer) {\n      clearInterval(waitForGtagTimer!);\n      waitForGtagTimer = null;\n\n      initTracker({\n        // send events through gtag when it is available\n        send: (payload) => {\n          if (typeof gtag === \"function\") {\n            gtag(\"event\", \"ui_event\", payload);\n          } else {\n            dataLayer.push({\n              event: \"ui_event\",\n              ...payload,\n            });\n          }\n        },\n\n        captureSelector: true,\n        capturePath: true,\n        captureText: true,\n        captureXPath: true,\n      });\n\n      return;\n    }\n\n    if (waited >= MAX_WAIT) {\n      clearInterval(waitForGtagTimer!);\n      waitForGtagTimer = null;\n      console.warn(\"[GCE] gtag did not initialize in time — tracking disabled\");\n    }\n  }, POLL_INTERVAL);\n}\n\n/**\n * Resets listeners and timers; intended for test environments.\n * @internal\n * @returns void\n * @remarks\n * —\n */\nexport function _resetTrackerForTests() {\n  if (handler) {\n    document.removeEventListener(\"click\", handler);\n    document.removeEventListener(\"input\", handler);\n    handler = null;\n  }\n\n  if (waitForGtagTimer) {\n    clearInterval(waitForGtagTimer);\n    waitForGtagTimer = null;\n  }\n}\n\nif (typeof window !== \"undefined\" && !isVitest) {\n  startAutoInit();\n}\n\nexport default { init: initTracker };\n"],"names":["isSelectorUnique","selector","target","matches","buildSelector","node","element","tag","parts","cls","attr","shortSelector","pathParts","current","parent","tagName","nth","siblings","el","index","buildXPath","typeMap","sameTypeSiblings","sibling","handler","waitForGtagTimer","POLL_INTERVAL","MAX_WAIT","isVitest","_documentCurrentScript","initTracker","options","opts","e","payload","_a","startAutoInit","waited","gtag","dataLayer","hasDataLayer","_resetTrackerForTests"],"mappings":"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"}